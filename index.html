<script type="module">
  // ğŸ”‘ Firebase êµ¬ì„± (ì‚¬ìš©ìë‹˜ í”„ë¡œì íŠ¸ ê°’ ìœ ì§€)
  const firebaseConfig = {
    apiKey: "AIzaSyBa0Lo3qikOS495BmX4JAew63QF7h5FnC0",
    authDomain: "party-reservation.firebaseapp.com",
    projectId: "party-reservation",
    storageBucket: "party-reservation.firebasestorage.app",
    messagingSenderId: "566891379159",
    appId: "1:566891379159:web:8d69d4996dd859a295f392",
    measurementId: "G-XQBDVLWEJD"
  };

  // Firebase SDK
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import {
    getFirestore, doc, getDoc, setDoc, onSnapshot,
    runTransaction, getDocs, collection
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ---------- ìƒìˆ˜/ìš”ì†Œ ----------
  const DAYS = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];

  const $ = (id)=>document.getElementById(id);
  const nickEl         = $('nick');
  const saveNickBtn    = $('saveNick');
  const weekStartEl    = $('weekStart');
  const goWeekBtn      = $('goWeek');
  const btnWeekPicker  = $('btnWeekPicker');
  const weekLabel      = $('weekLabel');
  const weekStart2     = $('weekStart2');
  const goWeek2        = $('goWeek2');
  const btnWeekPicker2 = $('btnWeekPicker2');
  const prevWeek       = $('prevWeek');
  const nextWeek       = $('nextWeek');

  const eventDateEl    = $('eventDate');
  const btnDatePicker  = $('btnDatePicker');
  const eventTimeEl    = $('eventTime');
  const btnTimePicker  = $('btnTimePicker');

  const catEl          = $('catSelect');
  const dungeonEl      = $('dungeonSelect');
  const eventDiffEl    = $('eventDiff');
  const createEventBtn = $('createEvent');

  const eventsContainer= $('eventsContainer');
  const emptyHint      = $('emptyHint');

  // ë¶„ë¥˜/ë˜ì „/ë‚œì´ë„ í”„ë¦¬ì…‹
  const DUNGEONS = {
    abyss: [ {id:'mas',  name:'ë§ˆìŠ¤ ë˜ì „'} ],
    raid : [ {id:'glas', name:'ê¸€ë¼ìŠ¤ê¸°ë¸Œë„¨'}, {id:'succ', name:'ì„œíë²„ìŠ¤'} ]
  };
  const DIFFS = {
    mas : ['ì…ë¬¸','ì–´ë ¤ì›€','ë§¤ìš°ì–´ë ¤ì›€','ì§€ì˜¥1','ì§€ì˜¥2','ì§€ì˜¥3','ì§€ì˜¥4','ì§€ì˜¥5','ì§€ì˜¥6','ì§€ì˜¥7','ì…ë¬¸~ì§€ì˜¥6'],
    glas: ['ì…ë¬¸','ì–´ë ¤ì›€','ë§¤ìš°ì–´ë ¤ì›€'],
    succ: ['ì–´ë ¤ì›€']
  };
  const CAP = (dg)=> dg==='glas'? 8 : 4;

  // ë¡œì»¬ ì €ì¥ ë‹‰
  nickEl.value = localStorage.getItem('party_nick') || '';

  // ìœ í‹¸
  const pad2=n=>String(n).padStart(2,'0');
  function mondayOf(date){ const d=new Date(date); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); d.setHours(0,0,0,0); return d; }
  function weekIdFromDate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }

  // ì´ˆê¸° ì£¼ê°„
  const defMon = mondayOf(new Date());
  weekStartEl.valueAsDate = defMon;
  let CURRENT_WEEK_MON = defMon;
  let CURRENT_WEEK_ID  = weekIdFromDate(defMon);
  let CURRENT_USER     = null;

  // ---------- ì¸ì¦ ----------
  signInAnonymously(auth).catch(e=>{ console.error(e); alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: '+e.code); });
  onAuthStateChanged(auth, user=>{ if(user){ CURRENT_USER=user; boot(); } });

  // ---------- ë‹‰ë„¤ì„ ì €ì¥ ----------
  saveNickBtn?.addEventListener('click', ()=>{
    const v = (nickEl.value||'').trim(); if(!v){ alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    localStorage.setItem('party_nick', v); alert('ë‹‰ë„¤ì„ ì €ì¥ ì™„ë£Œ');
  });

  // ---------- í”½ì»¤ ë²„íŠ¼ ----------
  const safeShow = (el)=>{ if(el?.showPicker) el.showPicker(); else el?.focus(); };
  btnWeekPicker ?.addEventListener('click', ()=> safeShow(weekStartEl));
  btnWeekPicker2?.addEventListener('click', ()=> safeShow(weekStart2));
  btnDatePicker  ?.addEventListener('click', ()=> safeShow(eventDateEl));
  btnTimePicker  ?.addEventListener('click', ()=> safeShow(eventTimeEl));

  // ---------- ì£¼ê°„ ì´ë™ ----------
  goWeekBtn ?.addEventListener('click', ()=>{ const d=weekStartEl.valueAsDate;  if(!d){ alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return;} setWeekByDate(d); });
  goWeek2   ?.addEventListener('click', ()=>{ const d=weekStart2.valueAsDate; if(!d){ alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return;} setWeekByDate(d); });
  prevWeek  ?.addEventListener('click', ()=>{ const d=new Date(CURRENT_WEEK_MON); d.setDate(d.getDate()-7); setWeekByDate(d); });
  nextWeek  ?.addEventListener('click', ()=>{ const d=new Date(CURRENT_WEEK_MON); d.setDate(d.getDate()+7); setWeekByDate(d); });

  function setWeekByDate(dateObj){
    CURRENT_WEEK_MON = mondayOf(dateObj);
    CURRENT_WEEK_ID  = weekIdFromDate(CURRENT_WEEK_MON);
    weekStartEl.valueAsDate = CURRENT_WEEK_MON;
    if(weekStart2) weekStart2.valueAsDate = CURRENT_WEEK_MON;
    boot();
  }

  // ---------- ë¶„ë¥˜â†’ë˜ì „â†’ë‚œì´ë„ ì—°ë™ ----------
  function refreshDungeons(){
    const cat = catEl.value; dungeonEl.innerHTML='';
    for(const d of DUNGEONS[cat]){ const o=document.createElement('option'); o.value=d.id; o.textContent=d.name; dungeonEl.appendChild(o); }
    refreshDiffs();
  }
  function refreshDiffs(){
    const dg = dungeonEl.value; eventDiffEl.innerHTML='';
    (DIFFS[dg]||[]).forEach(x=>{ const o=document.createElement('option'); o.value=x; o.textContent=x; eventDiffEl.appendChild(o); });
  }
  catEl.addEventListener('change', refreshDungeons);
  dungeonEl.addEventListener('change', refreshDiffs);
  refreshDungeons();

  // ì£¼ê°„ ë²”ìœ„ë¡œ íŒŒí‹° ìƒì„± ë‚ ì§œ ì œí•œ
  function syncEventDateRange(){
    const min=new Date(CURRENT_WEEK_MON);
    const max=new Date(CURRENT_WEEK_MON); max.setDate(max.getDate()+6);
    eventDateEl.min = `${min.getFullYear()}-${pad2(min.getMonth()+1)}-${pad2(min.getDate())}`;
    eventDateEl.max = `${max.getFullYear()}-${pad2(max.getMonth()+1)}-${pad2(max.getDate())}`;
    if(!eventDateEl.value){ eventDateEl.valueAsDate = new Date(CURRENT_WEEK_MON); }
  }

  // ---------- íŒŒí‹° ìƒì„± ----------
  createEventBtn.addEventListener('click', async ()=>{
    const nick=(nickEl.value||'').trim(); if(!nick){ alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.'); return; }
    const sel = new Date(eventDateEl.value); sel.setHours(0,0,0,0);
    const dIdx = Math.floor((sel - CURRENT_WEEK_MON)/86400000);
    if(dIdx<0 || dIdx>6){ alert('ì„ íƒí•œ ë‚ ì§œê°€ í˜„ì¬ ì£¼ê°„(ì›”~ì¼) ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. ìƒë‹¨ "ì´ ì£¼ ë³´ê¸°"ë¡œ ì£¼ê°„ì„ ë¨¼ì € ë§ì¶°ì£¼ì„¸ìš”.'); return; }
    const time = eventTimeEl.value || '20:00';
    const cat = catEl.value; const dg = dungeonEl.value; const diff = eventDiffEl.value; const cap = CAP(dg);
    const sid = `${dIdx}-${time}`;

    const slotRef = doc(db, 'weeks', CURRENT_WEEK_ID, 'slots', sid);
    await runTransaction(db, async (tx)=>{
      const snap = await tx.get(slotRef);
      let data = snap.exists()? snap.data(): { events: [] };
      const events = Array.isArray(data.events)? data.events: [];
      if(events.length >= 3) throw new Error('í•´ë‹¹ ì‹œê°„ëŒ€ì˜ íŒŒí‹°ê°€ ì´ë¯¸ 3ê°œì…ë‹ˆë‹¤.');
      // ë™ì‹œê°„ëŒ€ ì¤‘ë³µ ë°©ì§€: ë‚´ uid ì œê±°
      for(const e of events){ e.members = (e.members||[]).filter(m=>m.uid!==CURRENT_USER.uid); }
      const id = 'e'+Date.now()+Math.random().toString(36).slice(2,7);
      events.push({
        id, cat, dg, diff, cap,
        title: `${nick}ì˜ íŒŒí‹°`,
        hostUid: CURRENT_USER.uid, hostNick: nick,
        members:[{uid:CURRENT_USER.uid, nick}],
        createdAt: Date.now()
      });
      data.events = events; tx.set(slotRef, data);
    }).catch(e=> alert(e.message));

    // ì£¼ê°„ times ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
    const weekRef = doc(db, 'weeks', CURRENT_WEEK_ID);
    const wSnap = await getDoc(weekRef);
    const times = wSnap.exists()? (wSnap.data().times||[]) : [];
    if(!times.includes(time)){ await setDoc(weekRef, { times: [...times, time] }, { merge:true }); }
  });

  // ---------- ì‹¤ì‹œê°„ êµ¬ë… & ë Œë” ----------
  let unsubWeek = null; let slotUnsubs = []; const SLOT_DATA = new Map();
  function unsubAll(){ if(unsubWeek) try{unsubWeek();}catch(e){} unsubWeek=null; for(const u of slotUnsubs) try{u();}catch(e){} slotUnsubs=[]; }

  function boot(){
    unsubAll();
    const sun=new Date(CURRENT_WEEK_MON); sun.setDate(CURRENT_WEEK_MON.getDate()+6);
    weekLabel.textContent = `${CURRENT_WEEK_MON.getFullYear()}-${pad2(CURRENT_WEEK_MON.getMonth()+1)}-${pad2(CURRENT_WEEK_MON.getDate())} ~ ${sun.getFullYear()}-${pad2(sun.getMonth()+1)}-${pad2(sun.getDate())}`;
    if(weekStart2) weekStart2.valueAsDate = CURRENT_WEEK_MON;
    syncEventDateRange();

    const wRef = doc(db, 'weeks', CURRENT_WEEK_ID); setDoc(wRef, { times: [] }, { merge: true });
    // ë¹ˆ times ìë™ ë³µêµ¬(ê¸°ì¡´ ìŠ¬ë¡¯ì—ì„œ ìˆ˜ì§‘)
    hydrateTimesIfMissing(CURRENT_WEEK_ID);
    unsubWeek = onSnapshot(wRef, (snap)=>{
      const times = snap.exists()? (snap.data().times||[]) : [];
      if(!times || times.length===0){ hydrateTimesIfMissing(CURRENT_WEEK_ID); }
      attachSlotListeners(times);
    });
  }

  async function hydrateTimesIfMissing(weekId){
    try{
      const wRef = doc(db,'weeks',weekId); const wSnap = await getDoc(wRef);
      const times = wSnap.exists()? (wSnap.data().times||[]) : [];
      if(times.length>0) return;
      const snaps = await getDocs(collection(db,'weeks',weekId,'slots'));
      const found = new Set();
      snaps.forEach(d=>{ const id=d.id; const parts=id.split('-'); if(parts.length>=2) found.add(parts.slice(1).join('-')); });
      if(found.size>0){ await setDoc(wRef, { times:[...found].sort() }, { merge:true }); }
    }catch(e){ console.warn('hydrateTimesIfMissing failed', e); }
  }

  async function pruneWeekTimeIfEmpty(weekId, time){
    try{
      // í•´ë‹¹ ì£¼ì˜ ê°™ì€ timeì— ëŒ€í•´ ìš”ì¼ 0..6 ìŠ¬ë¡¯ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      for(let d=0; d<7; d++){
        const sRef = doc(db,'weeks',weekId,'slots',`${d}-${time}`);
        const sSnap = await getDoc(sRef);
        if(sSnap.exists()) return; // ì•„ì§ ë‚¨ì•„ìˆìŒ
      }
      // ì „ë¶€ ì—†ìœ¼ë©´ week.timesì—ì„œ ì œê±°
      const wRef = doc(db,'weeks',weekId);
      const wSnap = await getDoc(wRef);
      if(!wSnap.exists()) return;
      const times = wSnap.data().times||[];
      const next = times.filter(t=>t!==time);
      await setDoc(wRef, { times: next }, { merge:true });
    }catch(e){ console.warn('pruneWeekTimeIfEmpty failed', e); }
  }

  function attachSlotListeners(times){
    for(const u of slotUnsubs) try{u();}catch(e){} slotUnsubs = [];
    SLOT_DATA.clear();
    if(!times || times.length===0){ renderEvents(); return; }
    for(let d=0; d<7; d++){
      for(const t of [...times].sort()){
        const sid = `${d}-${t}`;
        const sRef = doc(db, 'weeks', CURRENT_WEEK_ID, 'slots', sid);
        const unsub = onSnapshot(sRef, (snap)=>{
          const data = snap.exists()? snap.data(): { events: [] };
          SLOT_DATA.set(`${d}|${t}`, data.events||[]);
          renderEvents();
        });
        slotUnsubs.push(unsub);
      }
    }
  }

  function labelCat(c){ return c==='abyss'?'ì–´ë¹„ìŠ¤':'ë ˆì´ë“œ'; }
  function labelDungeon(id){ return id==='mas'?'ë§ˆìŠ¤ ë˜ì „':(id==='glas'?'ê¸€ë¼ìŠ¤ê¸°ë¸Œë„¨':'ì„œíë²„ìŠ¤'); }
  function dungeonClass(id){ return id==='mas'?'dg-mas':(id==='glas'?'dg-glas':'dg-succ'); }

  function diffClass(name){
    const n = String(name||'').replace(/\s+/g,'');
    if(n==='ì…ë¬¸') return 'diff-easy';
    if(n==='ì–´ë ¤ì›€') return 'diff-hard';
    if(n==='ë§¤ìš°ì–´ë ¤ì›€') return 'diff-veryhard';
    if(n==='ì…ë¬¸~ì§€ì˜¥6' || n==='ì…ë¶„~ì§€6') return 'diff-pink';
    if(/^ì§€ì˜¥\d+$/.test(n)) return 'diff-veryhard';
    return '';
  }

  function renderEvents(){
    eventsContainer.innerHTML='';
    let any=false;
    for(let d=0; d<7; d++){
      const list=[];
      for(const [key, events] of SLOT_DATA.entries()){
        const [dd, time] = key.split('|');
        if(Number(dd)===d && Array.isArray(events) && events.length>0){ list.push({ time, events }); }
      }
      if(list.length===0) continue; any=true; list.sort((a,b)=> a.time.localeCompare(b.time));

      const dayEl=document.createElement('section'); dayEl.className='day';
      const dateObj=new Date(CURRENT_WEEK_MON); dateObj.setDate(CURRENT_WEEK_MON.getDate()+d);
      const dateStr=`${pad2(dateObj.getMonth()+1)}-${pad2(dateObj.getDate())}`;
      dayEl.innerHTML = `<header><h2>${DAYS[d]} <span class="date">${dateStr}</span></h2></header>`;
      const slotsEl=document.createElement('div'); slotsEl.className='slots';

      for(const item of list){
        const slotEl=document.createElement('div'); slotEl.className='slot';
        slotEl.innerHTML = `<div class="time">${item.time}</div>`;
        for(const ev of item.events){
          // ê³¼ê±° ë°ì´í„° í˜¸í™˜
          const cat = ev.cat || (ev.type==='abyss'?'abyss':'raid');
          const dg  = ev.dg  || (ev.type==='abyss'?'mas':(ev.type==='glas'?'glas':'succ'));
          const diffCls = diffClass(ev.diff);
          const full = (ev.members?.length||0) >= (ev.cap||4);
          const host = ev.hostNick || (ev.members?.[0]?.nick || 'íŒŒí‹°');
          const title = ev.title || `${host}ì˜ íŒŒí‹°`;
          const names = (ev.members||[]).map(m=>`<span class="chip">${escapeHtml(m.nick)}</span>`).join('') || '<span class="muted">(ë¹„ì–´ìˆìŒ)</span>';
          const evEl=document.createElement('div'); evEl.className='event'+(full?' full':'');
          evEl.innerHTML = `
            <div>
              <div class="label">
                <span class="badge ${cat==='abyss'?'cat-abyss':'cat-raid'}">${labelCat(cat)}</span>
                <span class="badge ${dungeonClass(dg)}">${labelDungeon(dg)}</span>
                <span class="badge diff ${diffCls}">${ev.diff}</span>
                <span class="count">${(ev.members?.length||0)}/${ev.cap||4}</span>
              </div>
              <div class="title">${escapeHtml(title)}</div>
              <div class="names">${names}</div>
            </div>
            <div class="btns">
              <button class="btn-join">ì°¸ê°€</button>
              <button class="btn-leave">ì·¨ì†Œ</button>
            </div>`;
          evEl.querySelector('.btn-join').addEventListener('click', ()=>{
            const nick=(nickEl.value||'').trim(); if(!nick){ alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.'); return; }
            const sid = `${d}-${item.time}`; joinEvent(CURRENT_WEEK_ID, sid, ev.id, ev.cap||4);
          });
          evEl.querySelector('.btn-leave').addEventListener('click', ()=>{
            const sid = `${d}-${item.time}`; leaveEvent(CURRENT_WEEK_ID, sid);
          });
          // í˜¸ìŠ¤íŠ¸ ì „ìš© ì‚­ì œ ë²„íŠ¼
          if(ev.hostUid && CURRENT_USER && ev.hostUid===CURRENT_USER.uid){
            const delBtn = document.createElement('button');
            delBtn.className='btn-delete'; delBtn.textContent='ì‚­ì œ';
            evEl.querySelector('.btns').appendChild(delBtn);
            delBtn.addEventListener('click', ()=>{
              const sid = `${d}-${item.time}`; deleteEvent(CURRENT_WEEK_ID, sid, ev.id);
            });
          }
          slotEl.appendChild(evEl);
        }
        slotsEl.appendChild(slotEl);
      }
      dayEl.appendChild(slotsEl);
      eventsContainer.appendChild(dayEl);
    }
    emptyHint.style.display = any? 'none':'block';
  }

  // ---- ì°¸ê°€/ì·¨ì†Œ/ì‚­ì œ + ë¹ˆ íŒŒí‹° ìë™ ì •ë¦¬ ----
  async function joinEvent(weekId, sid, eventId, cap){
    const nick=(nickEl.value||'').trim(); if(!nick){ alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.'); return; }
    const ref = doc(db, 'weeks', weekId, 'slots', sid);
    await runTransaction(db, async (tx)=>{
      const snap = await tx.get(ref);
      if(!snap.exists()) throw new Error('í•´ë‹¹ íŒŒí‹°ê°€ ì‚­ì œë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      let events = snap.data().events||[];
      // 1) ë™ì‹œê°„ëŒ€ ì¤‘ë³µ ì œê±°
      for(const e of events){ e.members = (e.members||[]).filter(m=>m.uid!==CURRENT_USER.uid); }
      // 2) ëŒ€ìƒì— ì¶”ê°€
      const target = events.find(e=>e.id===eventId);
      if(!target) throw new Error('í•´ë‹¹ íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      if((target.members?.length||0) >= (target.cap||cap)) throw new Error('ì •ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.');
      target.members = [...(target.members||[]), { uid: CURRENT_USER.uid, nick }];
      // 3) ë©¤ë²„ 0 ì´ë²¤íŠ¸ ì œê±°
      events = events.filter(e => (e.members?.length||0) > 0);
      if(events.length===0){ tx.delete(ref); } else { tx.set(ref, { events }, { merge:true }); }
    }).catch(e=>alert(e.message));
    // ì£¼ê°„ times ì •ë¦¬
    const time = sid.split('-').slice(1).join('-');
    await pruneWeekTimeIfEmpty(weekId, time);
  }

  async function leaveEvent(weekId, sid){
    const ref = doc(db, 'weeks', weekId, 'slots', sid);
    await runTransaction(db, async (tx)=>{
      const snap = await tx.get(ref); if(!snap.exists()) return;
      let events = (snap.data().events||[]);
      let changed=false;
      for(const e of events){
        const before=e.members||[]; const after=before.filter(m=>m.uid!==CURRENT_USER.uid);
        if(after.length!==before.length){ e.members=after; changed=true; }
      }
      // ë©¤ë²„ 0 ì´ë²¤íŠ¸ ì‚­ì œ
      events = events.filter(e => (e.members?.length||0) > 0);
      if(!changed && events.length>0) return; // ë³€ê²½ ì—†ìŒ
      if(events.length===0){ tx.delete(ref); } else { tx.set(ref, { events }, { merge:true }); }
    }).catch(e=>console.warn(e));
    // ì£¼ê°„ times ì •ë¦¬
    const time = sid.split('-').slice(1).join('-');
    await pruneWeekTimeIfEmpty(weekId, time);
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  }

  async function deleteEvent(weekId, sid, eventId){
    const ref = doc(db,'weeks',weekId,'slots',sid);
    await runTransaction(db, async (tx)=>{
      const snap = await tx.get(ref); if(!snap.exists()) return;
      const events = (snap.data().events||[]).filter(e=>e.id!==eventId);
      if(events.length===0){ tx.delete(ref); } else { tx.set(ref,{ events },{ merge:true }); }
    }).catch(e=>alert(e.message));
    const time = sid.split('-').slice(1).join('-');
    await pruneWeekTimeIfEmpty(weekId, time);
  }
</script>

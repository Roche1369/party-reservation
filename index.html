<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì£¼ê°„ íŒŒí‹° ì˜ˆì•½íŒ (ë™ì‹œê°„ëŒ€ ìµœëŒ€ 3íŒŒí‹°)</title>
  <style>
    :root{--bg:#0b0f14;--card:#121821;--muted:#8aa1b2;--accent:#64a9ff;--ok:#2ecc71;--warn:#ffb84d;--danger:#ff6b6b;--line:#1f2a36;--accentBg:#0e2236}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,'Noto Sans KR','Malgun Gothic',sans-serif;background:var(--bg);color:#e6eef5}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 10px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .section-head{margin-bottom:14px}
    label{font-size:14px;color:#8aa1b2}
    input,select,button{height:36px;border-radius:10px;border:1px solid var(--line);background:#0f141b;color:#e6eef5;padding:0 10px}
    /* í•˜ëŠ˜ìƒ‰ ê°•ì¡° ìŠ¤íƒ€ì¼ */
    input[type="date"], input[type="time"], select{border-color:var(--accent);background:var(--accentBg)}
    input[type="date"]:focus, input[type="time"]:focus, select:focus{outline:none;box-shadow:0 0 0 3px rgba(100,169,255,.25)}
    button{cursor:pointer}
    button.primary{background:var(--accent);border-color:transparent;color:#00172e;font-weight:700}
    .hint{font-size:12px;color:#99b2c7}
    .muted{color:#8aa1b2}

    /* ì´ë²¤íŠ¸ ë¦¬ìŠ¤íŠ¸ (ìˆëŠ” ì‹œê°„ë§Œ) */
    .events{display:flex;flex-direction:column;gap:18px}
    .day{border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .day>header{display:flex;align-items:center;justify-content:space-between;background:#0f141b;padding:12px;border-bottom:1px solid var(--line)}
    .day>header h2{font-size:15px;margin:0;color:#cfe3f2;display:flex;gap:8px;align-items:center}
    .day>header .date{font-size:12px;color:#8aa1b2;border:1px solid var(--line);padding:2px 8px;border-radius:999px}
    .slots{padding:16px;display:flex;flex-direction:column;gap:14px}
    .slot{border:1px solid var(--line);border-radius:12px;padding:12px}
    .slot .time{font-weight:700;color:#bcd0df;margin-bottom:8px}
    .event{display:grid;grid-template-columns:1fr auto;gap:10px;border:1px solid var(--line);border-radius:12px;padding:12px;background:#0e131a;margin-top:8px}
    .label{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:#bcd0df}
    .title{font-weight:700;margin:6px 0 4px 0}
    .names{display:flex;gap:6px;flex-wrap:wrap}
    .chip{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #294f77;background:linear-gradient(180deg,#10263c,#0b1624);color:#d3e8ff}
    .btns{display:flex;gap:6px}
    .btn-join{background:#21354a;color:#cfe3f2}
    .btn-leave{background:#2a1b1b;color:#ffd5d5;border-color:#512b2b}
    .count{font-weight:700}
    .full{border-color:#3a2a12;background:#1a1410}
    .full .count{color:var(--warn)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ì£¼ê°„ íŒŒí‹° ì˜ˆì•½íŒ <span class="hint">(ë™ì‹œê°„ëŒ€ ìµœëŒ€ 3íŒŒí‹° Â· ì£¼ê°„ ë³´ê¸°)</span></h1>

    <!-- ê¸°ë³¸ ì •ë³´ -->
    <div class="card">
      <div class="row">
        <div style="display:flex;gap:10px;align-items:center">
          <label>ë³„ëª…/ë‹‰ë„¤ì„</label>
          <input id="nick" placeholder="ì¸ê²Œì„ ë‹‰ë„¤ì„" style="width:180px" />
          <button id="saveNick" class="primary">ë‹‰ë„¤ì„ ì €ì¥</button>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <label>ì£¼ê°„ ì‹œì‘ì¼(ì›”ìš”ì¼)</label>
          <input type="date" id="weekStart" />
          <button id="goWeek" class="primary">í•´ë‹¹ ì£¼ ë³´ê¸°</button>
        </div>
      </div>
      <div class="hint" style="margin-top:8px">ë‹‰ë„¤ì„ì„ ì €ì¥í•˜ë©´ í´ë¦­ í•œ ë²ˆìœ¼ë¡œ ì°¸ê°€/ì·¨ì†Œê°€ ë©ë‹ˆë‹¤. ì´ í™”ë©´ì€ ì„ íƒí•œ â€˜í•´ë‹¹ ì£¼â€™ì˜ íŒŒí‹°ë§Œ ë³´ì—¬ì¤ë‹ˆë‹¤.</div>
    </div>

    <!-- íŒŒí‹° ìƒì„± -->
    <div class="card">
      <div class="row" style="row-gap:10px">
        <strong>íŒŒí‹° ìƒì„±</strong>
        <div style="display:flex;gap:10px;align-items:center">
          <label>ë‚ ì§œ</label>
          <input type="date" id="eventDate" />
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <label>ì‹œê°„</label>
          <input type="time" id="eventTime" value="20:00" step="1800" />
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <label>ë˜ì „</label>
          <select id="eventType">
            <option value="abyss">ì–´ë¹„ìŠ¤</option>
            <option value="glas">ê¸€ë¼ìŠ¤ê¸°ë¸Œë„¨</option>
            <option value="succubus">ì„œíë²„ìŠ¤</option>
          </select>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <label>ë‚œì´ë„</label>
          <select id="eventDiff"></select>
        </div>
        <div class="hint">ì •ì›ì€ ë˜ì „ì— ë”°ë¼ ìë™ ì„¤ì •ë©ë‹ˆë‹¤: ì–´ë¹„ìŠ¤ 4 / ê¸€ë¼ìŠ¤ê¸°ë¸Œë„¨ 8 / ì„œíë²„ìŠ¤ 4</div>
        <div style="flex:1"></div>
        <button id="createEvent" class="primary">íŒŒí‹° ìƒì„±</button>
      </div>
    </div>

    <!-- ì£¼ê°„ íŒŒí‹° ëª©ë¡ (ìˆëŠ” ì‹œê°„ë§Œ í‘œì‹œ) -->
    <div class="card">
      <div class="row section-head" style="justify-content:space-between; margin-bottom:8px">
        <strong>ì´ë²ˆ ì£¼ íŒŒí‹° ëª©ë¡</strong>
        <span class="muted" id="weekLabel"></span>
      </div>
      <div id="eventsContainer" class="events"></div>
      <div class="hint" id="emptyHint" style="display:none; margin-top:8px">ì•„ì§ ìƒì„±ëœ íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ íŒŒí‹°ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.</div>
    </div>

    <div class="hint">âš™ï¸ ë¬´ë£Œ í˜¸ìŠ¤íŒ…: GitHub Pages Â· ë°ì´í„°: Firebase Firestore(ìµëª… ë¡œê·¸ì¸)</div>
  </div>

  <script type="module">
    // ğŸ”‘ Firebase êµ¬ì„± (ì‚¬ìš©ìë‹˜ í”„ë¡œì íŠ¸ ê°’ìœ¼ë¡œ êµì²´ë¨)
    const firebaseConfig = {
      apiKey: "AIzaSyBa0Lo3qikOS495BmX4JAew63QF7h5FnC0",
      authDomain: "party-reservation.firebaseapp.com",
      projectId: "party-reservation",
      storageBucket: "party-reservation.firebasestorage.app",
      messagingSenderId: "566891379159",
      appId: "1:566891379159:web:8d69d4996dd859a295f392",
      measurementId: "G-XQBDVLWEJD"
    };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, runTransaction } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- ìƒìˆ˜/ìš”ì†Œ ----------
    const DAYS = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];

    const nickEl = document.getElementById('nick');
    const saveNickBtn = document.getElementById('saveNick');
    const weekStartEl = document.getElementById('weekStart');
    const goWeekBtn = document.getElementById('goWeek');
    const weekLabel = document.getElementById('weekLabel');

    const eventDateEl = document.getElementById('eventDate');
    const eventTimeEl = document.getElementById('eventTime');
    const eventTypeEl = document.getElementById('eventType');
    const eventDiffEl = document.getElementById('eventDiff');
    const createEventBtn = document.getElementById('createEvent');

    const eventsContainer = document.getElementById('eventsContainer');
    const emptyHint = document.getElementById('emptyHint');

    // ë‚œì´ë„ í”„ë¦¬ì…‹ & ì •ì›
    const DIFFS = {
      abyss: ['ì…ë¬¸','ì–´ë ¤ì›€','ë§¤ìš°ì–´ë ¤ì›€','ì§€ì˜¥1','ì§€ì˜¥2','ì§€ì˜¥3','ì§€ì˜¥4','ì§€ì˜¥5','ì§€ì˜¥6','ì§€ì˜¥7','ì…ë¬¸~ì§€ì˜¥6'],
      glas: ['ì…ë¬¸','ì–´ë ¤ì›€','ë§¤ìš°ì–´ë ¤ì›€'],
      succubus: ['ì–´ë ¤ì›€']
    };
    const CAP = { abyss:4, glas:8, succubus:4 };

    // ë¡œì»¬ ì €ì¥ ë‹‰
    nickEl.value = localStorage.getItem('party_nick') || '';

    // ìœ í‹¸
    function mondayOf(date){ const d = new Date(date); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); d.setHours(0,0,0,0); return d; }
    function pad2(n){ return String(n).padStart(2,'0'); }
    function dayIdxFromDate(target, mon){ const diff = Math.floor((target - mon)/86400000); return diff; }

    // ì´ˆê¸° ì£¼ê°„
    const defMon = mondayOf(new Date());
    weekStartEl.valueAsDate = defMon; // ì…ë ¥ê°’ë„ ì›”ìš”ì¼ë¡œ ìŠ¤ëƒ…

    let CURRENT_WEEK_MON = defMon; // ì‹¤ì œ ì›”ìš”ì¼ ë‚ ì§œ
    let CURRENT_WEEK_ID = weekIdFromDate(CURRENT_WEEK_MON);
    let CURRENT_USER = null;

    function weekIdFromDate(d){ const y=d.getFullYear(); const m=pad2(d.getMonth()+1); const day=pad2(d.getDate()); return `${y}-${m}-${day}`; }

    // ---------- ì¸ì¦ ----------
    signInAnonymously(auth).catch(e=>{ console.error(e); alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: '+e.code); });
    onAuthStateChanged(auth, user=>{ if(user){ CURRENT_USER=user; boot(); } });

    // ---------- ë‹‰ë„¤ì„ ì €ì¥ ----------
    saveNickBtn.onclick = ()=>{ const v = nickEl.value.trim(); if(!v){ alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; } localStorage.setItem('party_nick', v); alert('ë‹‰ë„¤ì„ ì €ì¥ ì™„ë£Œ'); };

    // ---------- ì£¼ê°„ ì´ë™ (ì„ íƒê°’ì„ ì›”ìš”ì¼ë¡œ ìŠ¤ëƒ…) ----------
    goWeekBtn.onclick = ()=>{
      const picked = weekStartEl.valueAsDate; if(!picked){ alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
      CURRENT_WEEK_MON = mondayOf(picked);
      weekStartEl.valueAsDate = CURRENT_WEEK_MON; // UIë„ ì›”ìš”ì¼ë¡œ ë³´ì •
      CURRENT_WEEK_ID = weekIdFromDate(CURRENT_WEEK_MON);
      boot();
    };

    // ---------- íŒŒí‹° ìƒì„± í¼ ----------
    function refreshDiffs(){ const type = eventTypeEl.value; const arr=DIFFS[type]; eventDiffEl.innerHTML=''; for(const x of arr){ const o=document.createElement('option'); o.value=x; o.textContent=x; eventDiffEl.appendChild(o); } }
    eventTypeEl.addEventListener('change', refreshDiffs); refreshDiffs();

    // ì£¼ê°„ ë²”ìœ„ì— ë§ê²Œ íŒŒí‹° ìƒì„± ë‚ ì§œ ì œí•œ
    function syncEventDateRange(){ const min=new Date(CURRENT_WEEK_MON); const max=new Date(CURRENT_WEEK_MON); max.setDate(max.getDate()+6); eventDateEl.min = `${min.getFullYear()}-${pad2(min.getMonth()+1)}-${pad2(min.getDate())}`; eventDateEl.max = `${max.getFullYear()}-${pad2(max.getMonth()+1)}-${pad2(max.getDate())}`; if(!eventDateEl.value){ eventDateEl.valueAsDate = new Date(CURRENT_WEEK_MON); } }

    createEventBtn.onclick = async ()=>{
      const nick=(nickEl.value||'').trim(); if(!nick){ alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.'); return; }
      const sel = new Date(eventDateEl.value); sel.setHours(0,0,0,0);
      const dIdx = dayIdxFromDate(sel, CURRENT_WEEK_MON);
      if(dIdx<0 || dIdx>6){ alert('ì„ íƒí•œ ë‚ ì§œê°€ í˜„ì¬ ì£¼ê°„(ì›”~ì¼) ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. ìƒë‹¨ "í•´ë‹¹ ì£¼ ë³´ê¸°"ë¡œ ì£¼ê°„ì„ ë¨¼ì € ë§ì¶°ì£¼ì„¸ìš”.'); return; }
      const time = eventTimeEl.value || '20:00';
      const type = eventTypeEl.value; const diff = eventDiffEl.value; const cap = CAP[type] || 4;
      const sid = `${dIdx}-${time}`;

      const slotRef = doc(db, 'weeks', CURRENT_WEEK_ID, 'slots', sid);
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(slotRef);
        let data = snap.exists()? snap.data(): { events: [] };
        const events = Array.isArray(data.events)? data.events: [];
        if(events.length >= 3) throw new Error('í•´ë‹¹ ì‹œê°„ëŒ€ì˜ íŒŒí‹°ê°€ ì´ë¯¸ 3ê°œì…ë‹ˆë‹¤.');
        // ë™ì‹œê°„ëŒ€ ì¤‘ë³µ ë°©ì§€
        for(const e of events){ e.members = (e.members||[]).filter(m=>m.uid!==CURRENT_USER.uid); }
        const id = 'e'+Date.now()+Math.random().toString(36).slice(2,7);
        events.push({ id, type, diff, cap, title: `${nick}ì˜ íŒŒí‹°`, hostUid: CURRENT_USER.uid, hostNick: nick, members:[{uid:CURRENT_USER.uid, nick}], createdAt: Date.now() });
        data.events = events; tx.set(slotRef, data);
      }).catch(e=> alert(e.message));

      // ì£¼ê°„ íƒ€ì„ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸ (ìˆëŠ” ì‹œê°„ë§Œ í‘œì‹œ)
      const weekRef = doc(db, 'weeks', CURRENT_WEEK_ID);
      const wSnap = await getDoc(weekRef);
      const times = wSnap.exists()? (wSnap.data().times||[]) : [];
      if(!times.includes(time)){ await setDoc(weekRef, { times: [...times, time] }, { merge:true }); }
    };

    // ---------- ì‹¤ì‹œê°„ êµ¬ë… & ë Œë” ----------
    let unsubWeek = null; let slotUnsubs = []; const SLOT_DATA = new Map();
    function unsubAll(){ if(unsubWeek) try{unsubWeek();}catch(e){} unsubWeek=null; for(const u of slotUnsubs) try{u();}catch(e){} slotUnsubs=[]; }

    function boot(){
      unsubAll();
      const sun=new Date(CURRENT_WEEK_MON); sun.setDate(CURRENT_WEEK_MON.getDate()+6);
      weekLabel.textContent = `${CURRENT_WEEK_MON.getFullYear()}-${pad2(CURRENT_WEEK_MON.getMonth()+1)}-${pad2(CURRENT_WEEK_MON.getDate())} ~ ${sun.getFullYear()}-${pad2(sun.getMonth()+1)}-${pad2(sun.getDate())}`;
      syncEventDateRange();

      const wRef = doc(db, 'weeks', CURRENT_WEEK_ID); setDoc(wRef, { times: [] }, { merge: true });
      unsubWeek = onSnapshot(wRef, (snap)=>{ const times = snap.exists()? (snap.data().times||[]) : []; attachSlotListeners(times); });
    }

    function attachSlotListeners(times){ for(const u of slotUnsubs) try{u();}catch(e){} slotUnsubs = []; SLOT_DATA.clear(); if(!times || times.length===0){ renderEvents(); return; } for(let d=0; d<7; d++){ for(const t of [...times].sort()){ const sid = `${d}-${t}`; const sRef = doc(db, 'weeks', CURRENT_WEEK_ID, 'slots', sid); const unsub = onSnapshot(sRef, (snap)=>{ const data = snap.exists()? snap.data(): { events: [] }; SLOT_DATA.set(`${d}|${t}`, data.events||[]); renderEvents(); }); slotUnsubs.push(unsub); } } }

    function renderEvents(){ eventsContainer.innerHTML=''; let any=false; for(let d=0; d<7; d++){ const list=[]; for(const [key, events] of SLOT_DATA.entries()){ const [dd, time] = key.split('|'); if(Number(dd)===d && Array.isArray(events) && events.length>0){ list.push({ time, events }); } } if(list.length===0) continue; any=true; list.sort((a,b)=> a.time.localeCompare(b.time)); const dayEl=document.createElement('section'); dayEl.className='day'; const dateObj=new Date(CURRENT_WEEK_MON); dateObj.setDate(CURRENT_WEEK_MON.getDate()+d); const dateStr=`${pad2(dateObj.getMonth()+1)}-${pad2(dateObj.getDate())}`; dayEl.innerHTML = `<header><h2>${DAYS[d]} <span class="date">${dateStr}</span></h2></header>`; const slotsEl=document.createElement('div'); slotsEl.className='slots'; for(const item of list){ const slotEl=document.createElement('div'); slotEl.className='slot'; slotEl.innerHTML = `<div class="time">${item.time}</div>`; for(const ev of item.events){ const full = (ev.members?.length||0) >= (ev.cap||4); const host = ev.hostNick || (ev.members?.[0]?.nick || 'íŒŒí‹°'); const title = ev.title || `${host}ì˜ íŒŒí‹°`; const names = (ev.members||[]).map(m=>`<span class="chip">${escapeHtml(m.nick)}</span>`).join('') || '<span class="muted">(ë¹„ì–´ìˆìŒ)</span>'; const evEl=document.createElement('div'); evEl.className='event'+(full?' full':''); evEl.innerHTML = `<div><div class="label"><span class="badge">${labelType(ev.type)}</span><span class="badge">${ev.diff}</span><span class="count">${(ev.members?.length||0)}/${ev.cap||4}</span></div><div class="title">${escapeHtml(title)}</div><div class="names">${names}</div></div><div class="btns"><button class="btn-join">ì°¸ê°€</button><button class="btn-leave">ì·¨ì†Œ</button></div>`; evEl.querySelector('.btn-join').addEventListener('click', ()=>{ const nick=(nickEl.value||'').trim(); if(!nick){ alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.'); return; } const sid = `${d}-${item.time}`; joinEvent(CURRENT_WEEK_ID, sid, ev.id, ev.cap||4); }); evEl.querySelector('.btn-leave').addEventListener('click', ()=>{ const sid = `${d}-${item.time}`; leaveEvent(CURRENT_WEEK_ID, sid); }); slotEl.appendChild(evEl); } slotsEl.appendChild(slotEl); } dayEl.appendChild(slotsEl); eventsContainer.appendChild(dayEl); } emptyHint.style.display = any? 'none':'block'; }

    async function joinEvent(weekId, sid, eventId, cap){ const nick=(nickEl.value||'').trim(); if(!nick){ alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.'); return; } const ref = doc(db, 'weeks', weekId, 'slots', sid); await runTransaction(db, async (tx)=>{ const snap = await tx.get(ref); if(!snap.exists()) throw new Error('í•´ë‹¹ íŒŒí‹°ê°€ ì‚­ì œë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); const data = snap.data(); const events=data.events||[]; for(const e of events){ e.members = (e.members||[]).filter(m=>m.uid!==CURRENT_USER.uid); } const target = events.find(e=>e.id===eventId); if(!target) throw new Error('í•´ë‹¹ íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.'); if((target.members?.length||0) >= (target.cap||cap)) throw new Error('ì •ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.'); target.members = [...(target.members||[]), { uid: CURRENT_USER.uid, nick }]; tx.set(ref, { events }, { merge:true }); }).catch(e=>alert(e.message)); }

    async function leaveEvent(weekId, sid){ const ref = doc(db, 'weeks', weekId, 'slots', sid); await runTransaction(db, async (tx)=>{ const snap = await tx.get(ref); if(!snap.exists()) return; const data = snap.data(); const events=data.events||[]; let changed=false; for(const e of events){ const before=e.members||[]; const after=before.filter(m=>m.uid!==CURRENT_USER.uid); if(after.length!==before.length){ e.members=after; changed=true; } } if(changed) tx.set(ref, { events }, { merge:true }); }); }

    function labelType(t){ return t==='abyss'?'ì–´ë¹„ìŠ¤':(t==='glas'?'ê¸€ë¼ìŠ¤ê¸°ë¸Œë„¨':'ì„œíë²„ìŠ¤'); }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[c])); }

  </script>
</body>
</html>
